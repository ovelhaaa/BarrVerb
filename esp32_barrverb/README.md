# BarrVerb ESP32 Port

This directory contains the ESP32 port of the [BarrVerb](https://github.com/expert-sleepers/BarrVerb) reverb plugin. It runs the original DSP emulation of the Alesis MIDIVerb on an ESP32 microcontroller using the Arduino framework.

## Overview

The original BarrVerb is a software plugin (VST/LV2) that emulates the hardware DSP of the 1980s Alesis MIDIVerb. This port adapts that C++ code to run in real-time on an ESP32.

Key features:
*   **Real-time DSP**: Runs the original 128-step reverb algorithm.
*   **Stereo I/O**: Uses I2S for high-quality audio input and output.
*   **Program Control**: Switch between the 63 original reverb programs via Serial commands.
*   **Test Signal Generator**: Includes built-in impulse, saw, and sine wave generators for testing without external audio sources.

## Hardware Requirements

*   **ESP32 Development Board**: Any standard ESP32 board (e.g., Lolin32 Lite, DevKitC).
*   **I2S DAC**: PCM5102 or similar is recommended for line-level output.
    *   **BCLK**: GPIO 26
    *   **LRCK**: GPIO 25
    *   **DOUT**: GPIO 22
*   **I2S ADC (Optional)**: For processing external audio (not fully implemented in the example main loop, which defaults to signal generation).

## Building & Flashing

This project uses [PlatformIO](https://platformio.org/).

1.  **Install PlatformIO**: Install the VSCode extension or CLI.
2.  **Open Project**: Open the `esp32_barrverb` folder in PlatformIO.
3.  **Build**: Run the `Build` task.
4.  **Upload**: Connect your ESP32 and run the `Upload` task.
5.  **Monitor**: Open the Serial Monitor (115200 baud) to see status and control the unit.

## Usage

Once flashed, the ESP32 will start generating audio immediately.

### Serial Commands

Open the Serial Monitor at **115200 baud**. The following commands are available:

*   `+`: Next Program
*   `-`: Previous Program
*   `s`: Cycle Waveform (Sine -> Sawtooth -> Triangle -> Square)
*   `list`: Display current program and waveform settings

### Audio Output

Connect the output of your I2S DAC to an amplifier or headphones. You should hear the melody generated by the test signal generator processed by the reverb.

## Implementation Details

### Architecture

The port retains the core logic of the original `BarrVerb` C++ class but adapts it for the embedded environment:

*   **Integer Arithmetic**: The DSP core uses 16-bit integer arithmetic, matching the original hardware emulation. This is highly efficient on the ESP32's Xtensa LX6 processor.
*   **Memory Management**:
    *   **ROM**: The large lookup tables (ROM) are stored in Flash memory (`PROGMEM`) to save RAM. They are accessed via `pgm_read_word`.
    *   **RAM**: The 16k word delay memory is allocated on the heap using `malloc`.
*   **Sampling Rate**: The reverb runs effectively at ~22kHz (half of 44.1kHz), processing two output samples per DSP cycle, effectively oversampling the control logic but undersampling the audio path relative to modern 48k standards, which matches the vintage character of the original hardware.

### DSP Loop Optimization

The core `run()` loop processes audio in blocks (default 128 frames). For every two audio samples:
1.  Input samples are downsampled and filtered.
2.  The 128-step custom processor emulation runs.
3.  The output is upscaled and written to the I2S buffer.

### Source Code Structure

*   `src/main.cpp`: ESP32 setup, I2S configuration, signal generation, and main loop.
*   `src/BarrVerb.cpp`: The core reverb implementation.
*   `include/BarrVerb.h`: Class definition.
*   `include/rom.h`: The reversed-engineered ROM data (stored in flash).

## Credits

*   **Original Plugin**: [Expert Sleepers / os](https://github.com/expert-sleepers/BarrVerb)
*   **Reverse Engineering**: Eric Brombaugh, Paul Schreiber, and the synth-diy community.
*   **ESP32 Port**: Jules
